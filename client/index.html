<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CS.314 Chat App</title>
    <link rel="stylesheet" type="text/css" href="index.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="icon" href="https://chaterize.onrender.com/favicon.ico?v=2">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    
  </head>
  <body>


    <div class="google-container bg-dark">
      <div class="google-sign" id="googleButton"></div>
    </div>

    <div id="root"></div>
    <script src="index.js" type="text/babel"></script>

    <script>
      let socket = io();
      
      // make a global variable of the socket for other functions
      window.globalsocket = socket;

      // Source:
      // https://stackoverflow.com/questions/68927855/sign-in-with-google-console-log 
      // Gives decode without library
      window.decodeJwtResponse = function (token) 
      {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      }

      function save_cookie(response, exp)
      {
          response_string = JSON.stringify(response);
          document.cookie = "id_token=" + response_string + "; expires=" + new Date(exp * 1000).toUTCString()
          + "; SameSite=strict" +"; Secure" + "; path=/";
      }

      

      function handleCredentialResponse (response)
      {
        // decodeJwtResponse() is a custom function defined by you
        // to decode the credential response.
        const responsePayload = window.decodeJwtResponse(response.credential)
        const email = responsePayload['email']; 
        //console.log(email, "just tried to signed in.");
        globalsocket.emit('google_sign', response);
        
        //try to save token with expirary date
        save_cookie(response, responsePayload['exp']);
      }

      window.onload = function ()
      {
        google.accounts.id.initialize({
          client_id: '278406872967-ds0j19p8s6gouvvklrma8cmpjicpmnfu.apps.googleusercontent.com',
          callback: handleCredentialResponse,
          auto_select: false
        });

        if (document.cookie.indexOf('id_token=') === -1) {
          google.accounts.id.prompt();
        }

        google.accounts.id.renderButton(document.getElementById("googleButton"),
          { theme: "outline", size: "large", width: 234 }  // customization attributes
        );

      };
    </script>

  </body>
</html> 