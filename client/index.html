<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CS.314 Chat App</title>
    <link rel="stylesheet" type="text/css" href="index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- <link rel="shortcut icon" href="https://icons.duckduckgo.com/ip3/www.google.com.ico"> -->
    <link rel="shortcut icon" href="http://chaterize.onrender.com/favicon.ico"> 

  </head>
  <body class="no-scroll">

    <div class="google-sign" id="googleButton"></div>

    <div id="root"></div>
    <script src="index.js" type="text/babel"></script>

    <script>
      window.decodeJwtResponse = function (token) 
      {//from https://stackoverflow.com/questions/68927855/sign-in-with-google-console-log //gives decode without library
          var base64Url = token.split('.')[1];
          var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));

          return JSON.parse(jsonPayload);
      }

      function save_cookie(response, exp)
      {
          response_string = JSON.stringify(response);
          document.cookie = "id_token=" + response_string + "; expires=" + new Date(exp * 1000).toUTCString()
          + "; SameSite=strict" +"; Secure" + "; path=/";
      }

      let socket = io(); // May switch to const later.
      window.globalsocket = socket; // make a global variable of the socket for other functions

      function handleCredentialResponse (response)
      {
        // decodeJwtResponse() is a custom function defined by you
        // to decode the credential response.
        const responsePayload = window.decodeJwtResponse(response.credential)
        const email = responsePayload['email']; 
        //console.log(email, "just tried to signed in.");
        globalsocket.emit('google_sign', response);
        
        //try to save token with expirary date
        save_cookie(response, responsePayload['exp']);
      }

      window.onload = function () 
      {
        google.accounts.id.initialize({
          client_id: '278406872967-ds0j19p8s6gouvvklrma8cmpjicpmnfu.apps.googleusercontent.com',
          callback: handleCredentialResponse,
          auto_select: false, //make true for better sign in after cookie lapse but breaks signout

        });

        window.google_sign = google.accounts.id; //global if react needs to access
        if(document.cookie.indexOf('id_token=') == -1)
        {
          google.accounts.id.prompt();
        }
        
        google.accounts.id.renderButton(document.getElementById("googleButton"),
          { theme: "outline", size: "large" }  // customization attributes
        );
      };
    </script>

  </body>
</html> 